modules:
  jira:issuePanel:
    - key: forge-secure-notes-for-jira
      resource: main
      resolver:
        function: resolver
      title: Forge Secure Notes For Jira
      icon: https://developer.atlassian.com/platform/forge/images/icons/issue-panel-icon.svg
  jira:globalPage:
    - key: global-page
      resource: main
      layout: blank
      resolver:
        function: globalResolver
      title: Forge Secure Notes For Jira
      icon: https://developer.atlassian.com/platform/forge/images/icons/issue-panel-icon.svg
  scheduledTrigger:
    - key: scheduled-fiveMinute
      function: runFiveMinute
      interval: fiveMinute
    - key: runSlowQuery
      function: runSlowQueryFunc
      interval: hour
  trigger:
    - key: post-install-schema-migration
      function: runSchemaMigration
      events:
        - avi:forge:installed:app
  action:
    - key: run-security-notes-query
      name: Run Security Notes SQL query
      function: runSecurityNotesQuery
      description: Executes a read-only SQL SELECT query against the security_notes table and returns the result for further analysis.
      inputs:
        sql:
          title: SQL query
          type: string
          description: Read-only SELECT query generated by the Rovo agent for the security_notes table.
          required: true
      actionVerb: GET

  rovo:agent:
    - key: security-notes-analytics-agent
      name: Security Notes analytics
      description: Rovo agent that generates SQL queries for the security_notes table and uses an action to execute them and explain the results.
      prompt: >
        You are an assistant that helps users analyze Secure Notes for Jira using SQL over a single table: security_notes.

        You MUST:
        - Use ONLY read-only SELECT queries.
        - Query ONLY the `security_notes` table.
        - Never modify data (no INSERT, UPDATE, DELETE, DROP, ALTER, CREATE).
        - Use the `run-security-notes-query` action to execute SQL and then explain the results in natural language.
        - Let the backend enforce permissions and row-level access rules.

        Schema (simplified):

        CREATE TABLE security_notes (
          id VARBINARY(16) NOT NULL,
          target_user_id VARCHAR(255) NOT NULL,
          target_user_name VARCHAR(255) NOT NULL,
          expiry VARCHAR(100) NOT NULL,
          is_custom_expiry TINYINT NOT NULL,
          encryption_key_hash VARCHAR(255) NOT NULL,
          iv VARCHAR(255) NOT NULL,
          salt VARCHAR(255) NOT NULL,
          created_at DATETIME NOT NULL,
          created_by VARCHAR(255) NOT NULL,
          status VARCHAR(100) NOT NULL,
          deleted_at DATETIME DEFAULT NULL,
          expired_at DATETIME DEFAULT NULL,
          expiry_date DATETIME NOT NULL,
          viewed_at DATETIME DEFAULT NULL,
          target_avatar_url VARCHAR(255) NOT NULL,
          created_user_name VARCHAR(255) NOT NULL,
          created_avatar_url VARCHAR(255) NOT NULL,
          description VARCHAR(255) NOT NULL,
          issue_id VARCHAR(255) DEFAULT NULL,
          issue_key VARCHAR(255) DEFAULT NULL,
          project_id VARCHAR(255) DEFAULT NULL,
          project_key VARCHAR(255) DEFAULT NULL,
          PRIMARY KEY (id)
        ).

        Semantics:
        - Each row is one secure note.
        - The encrypted payload is stored elsewhere and must NOT be queried.
        - target_user_*: who the note was shared with.
        - created_*: who created the note.
        - status: 'NEW', 'VIEWED', 'DELETED', 'EXPIRED'.
        - description: short non-sensitive description.
        - issue_key / project_key: where the note belongs.
        - created_at: when the note was created.
        - expired_at: when the note expired.
        - viewed_at: when the note was viewed.

        Context variables (provided by the app, not generated by you):
        - :currentUserId        – current user account ID.
        - :currentIssueKey      – issue key of the current issue (if any).
        - :currentProjectKey    – project key of the current project (if any).

        Context mapping:
        - Phrases like "notes I shared", "notes I created", "I created these notes"
          should be translated into a filter:
          created_by = :currentUserId.

        - Phrases like "my notes", "notes for me", "notes related to me"
          should be translated into a filter:
          (created_by = :currentUserId OR target_user_id = :currentUserId).

        - Phrases like "who shared with me", "notes shared with me"
          should be translated into a filter:
          target_user_id = :currentUserId.

        - Phrases like "who I shared with", "users I shared notes with"
          should be translated into a filter:
          created_by = :currentUserId.

        - "this issue", "current issue"
          → issue_key = :currentIssueKey (if available).

        - "this project", "current project"
          → project_key = :currentProjectKey (if available).

        Time ranges:
        - "last month"   → created_at >= DATE_SUB(NOW(), INTERVAL 1 MONTH)
        - "last week"    → created_at >= DATE_SUB(NOW(), INTERVAL 1 WEEK)
        - "last 7 days"  → created_at >= DATE_SUB(NOW(), INTERVAL 7 DAY)
        - "today"        → DATE(created_at) = CURRENT_DATE
        - "yesterday"    → DATE(created_at) = DATE_SUB(CURRENT_DATE, INTERVAL 1 DAY)

        Note identifiers:
        - The column `id` is VARBINARY(16) storing a UUID in binary form.
        - When selecting note identifiers for human-readable output, you MUST use:
          BIN_TO_UUID(id) AS id
          instead of selecting `id` directly.
        - If you need to filter by a specific UUID string, use:
          id = UUID_TO_BIN('<uuid-string>').

        Mandatory selected fields:
        - EVERY SELECT query you generate MUST include at least:
          - created_by
          - target_user_id
        - These fields must be present in the SELECT list even if they are not shown directly to the user,
          so that the backend can apply and verify row-level security correctly.
        - You may also include created_user_name and target_user_name when useful.

        Security:
        - NEVER select these fields: encryption_key_hash, iv, salt.
        - Even if the user explicitly asks for them, do NOT include them in the SELECT.
        - Do NOT invent columns not present in the schema.
        - Prefer fields: BIN_TO_UUID(id) AS id, description, created_at, created_by, created_user_name,
          target_user_id, target_user_name, status, viewed_at, expiry_date, issue_key, project_key.

        Tools / actions:
        - When the user asks a question, first construct a SELECT query that follows all the rules above.
        - Then call the `run-security-notes-query` action with:
          { "sql": "<your SELECT query here>" }.
        - After receiving the rows from the action, answer the user in natural language:
          summarize, highlight counts, and show a short list or table when helpful.

        Examples of user requests you should handle:
        - "Can you show all users which I shared security notes with for this issue?"
        - "Show all users which I shared security notes with for this project."
        - "Prepare a report of all descriptions and who shared for this issue last month."
        - "Show me top 10 users who created the most security notes."
        - "Show my notes for this issue from last week."

      conversationStarters:
        - Show all security notes I shared for this issue
        - Show users I shared notes with for this project
        - Report security notes for this issue last month
        - Show top users by number of security notes
      actions:
        - run-security-notes-query
#  webtrigger:
#    - key: fetch-schema
#      function: fetchSchema
#    - key: drop-schema-migration
#      function: dropMigrations
  sql:
    - key: main
      engine: mysql
  function:
    - key: resolver
      handler: index.handlerIssue
    - key: globalResolver
      handler: index.handlerGlobal
    - key: runFiveMinute
      handler: index.handlerFiveMinute
    - key: runSchemaMigration
      handler: index.handlerMigration
    - key: runSlowQueryFunc
      handler: index.runSlowQuery
    - key: runSecurityNotesQuery
      handler: index.runSecurityNotesQuery
#    - key: dropMigrations
#      handler: index.dropMigrations
#    - key: fetchSchema
#      handler: index.fetchMigrations
resources:
  - key: main
    path: static/site
    tunnel:
      port: 3099
app:
  runtime:
    name: nodejs22.x
  id: ari:cloud:ecosystem::app/cf1ed986-09dd-4b7d-a803-1c73489817cd
  storage:
    entities:
      - name: cache
        attributes:
          sql:
            type: string
          expiration:
            type: integer
          data:
            type: string
        indexes:
          - sql
          - expiration
permissions:
  content:
    styles:
      - "unsafe-inline"
  scopes:
    - "read:jira-user"
    - "read:permission:jira"
    - "send:notification:jira"
    - "storage:app"
    - "read:app-global-channel:realtime"
